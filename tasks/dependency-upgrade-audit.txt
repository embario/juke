---
id: dep-upgrade-phase-1
title: Full-Stack Dependency Upgrade Audit + Execution Hooks
status: ready
priority: p1
owner: unassigned
area: platform
label: ALL/GENERAL
complexity: 5
updated_at: 2026-02-10
---

Objective
- Upgrade third-party dependencies across backend, web, Android, and iOS with minimal breakage risk.
- Do NOT do a single "upgrade everything" PR. Use phased, test-gated batches.

Summary of Findings
1) Highest risk: backend and recommender Python dependencies are unpinned.
   - backend/requirements.txt:1
   - backend/recommender_engine/requirements.txt:1
   - backend/Dockerfile:10 installs unbounded requirements each build
   - backend/recommender_engine/Dockerfile:5 installs unbounded requirements each build

2) Backend compatibility hotspots likely to break on majors:
   - rest_registration fallback import behavior:
     - backend/juke_auth/views.py:22
     - backend/juke_auth/views.py:25
   - OpenAI SDK integration:
     - backend/tunetrivia/services.py:264
     - backend/tunetrivia/services.py:290

3) Web compatibility hotspots:
   - React Router data-router APIs:
     - web/src/router.tsx:1
   - Runtime stack versions:
     - web/package.json:24 (react)
     - web/package.json:27 (react-router-dom)

4) Android currently on modern toolchain; toolchain upgrades should be isolated:
   - mobile/android/juke/build.gradle.kts:2 (AGP 9.0.0)
   - mobile/android/juke/build.gradle.kts:3 (Kotlin 2.2.10)
   - mobile/android/juke/gradle/wrapper/gradle-wrapper.properties:3 (Gradle 9.3.0)
   - mobile/android/juke/app/build.gradle.kts:56 (Java 21 sourceCompatibility)
   - CI still configures Java 17:
     - .github/workflows/ci.yml:121

5) iOS third-party surface is small, mostly ShotClock Spotify SDK:
   - mobile/ios/shotclock/ShotClock.xcodeproj/project.pbxproj:827 (upToNextMajorVersion >=2.0.0)
   - mobile/ios/shotclock/ShotClock.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved:10 (2.1.7 resolved)
   - mobile/ios/shotclock/ShotClock/Services/SpotifyManager.swift:3 (SpotifyiOS import)

6) Environment drift risk:
   - Dev compose DB image unpinned:
     - docker-compose.yml:3
   - CI compose DB pinned:
     - docker-compose.ci.yml:3

7) Coverage gap to account for:
   - Android CI covers juke + shotclock only:
     - .github/workflows/ci.yml:110
     - .github/workflows/ci.yml:125
   - No dedicated Android tunetrivia CI job currently.

Recommended Upgrade Sequence (low-risk first)
1) Stabilize inputs: pin Python deps (backend + recommender), optionally pin dev Postgres image.
2) Upgrade dev tooling only (lint/test/build tools).
3) Upgrade web build stack (Vite/plugin/test tooling) before runtime React libs.
4) Upgrade backend non-core libs (requests/rich/ipython/pillow) patch/minor.
5) Upgrade recommender deps (fastapi/uvicorn/numpy/psycopg) patch/minor.
6) Upgrade backend core stack (Django/DRF/auth/celery/redis/psycopg2) in small batches.
7) Upgrade web runtime libs (react/react-dom/router/three/react-globe.gl).
8) Upgrade Android app libraries (Compose/lifecycle/navigation/networking), keeping AGP/Kotlin/Gradle fixed initially.
9) Upgrade iOS Spotify SDK after backend/web/mobile APIs are stable.
10) Run majors one-by-one in separate PRs.

Execution Hooks for Next Agent
- Start with a baseline branch and snapshots:
  - git checkout -b chore/dependency-upgrades-phase-1
  - git status --short

- Backend + web baseline checks in compose:
  - docker compose -f docker-compose.ci.yml up -d db redis backend
  - docker compose -f docker-compose.ci.yml exec -T backend ruff check
  - docker compose -f docker-compose.ci.yml exec -T backend python manage.py test
  - docker compose -f docker-compose.ci.yml run --rm web npm run test

- Mobile baseline checks:
  - scripts/test_mobile.sh --android-only -p juke
  - scripts/test_mobile.sh --android-only -p shotclock
  - scripts/test_mobile.sh --ios-only -p juke
  - scripts/test_mobile.sh --ios-only -p shotclock
  - scripts/test_mobile.sh --ios-only -p tunetrivia

- Before each dependency batch:
  - Commit current green baseline.
  - Upgrade one subsystem at a time.
  - Re-run only relevant tests first, then full suite before merge.

Immediate TODO Checklist (Phase 1)
- [ ] Add pinned Python requirements (constraints or lock-based approach) for:
      backend/requirements.txt
      backend/recommender_engine/requirements.txt
- [ ] Decide and implement consistent Postgres image pinning between dev and CI.
- [ ] Add an Android CI job for tunetrivia or document explicit manual gating requirements.
- [ ] Record dependency policy in repo docs (pinning strategy + update cadence).

Definition of Done for This Task
- Dependency upgrades are delivered in phased PRs with passing tests per subsystem.
- Python dependency resolution is deterministic/reproducible in CI and local compose.
- Upgrade notes include rollback instructions and known incompatibilities.

Notes
- Live "current vs latest" package lookups were not completed in this environment due restricted network access. Run package-manager outdated checks on a machine with registry access before final version selection.
